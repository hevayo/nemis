worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # ── Shared proxy settings ──────────────────────────────────────────
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Large buffers for WSO2 (big headers / cookies)
    proxy_buffer_size        16k;
    proxy_buffers            8 32k;
    proxy_busy_buffers_size  64k;

    # ── hrm.emis.moe.gov.lk → Vite dev server ─────────────────────────
    server {
        listen 443 ssl;
        server_name hrm.emis.moe.gov.lk;

        ssl_certificate     /etc/nginx/certs/hrm.emis.moe.gov.lk.crt;
        ssl_certificate_key /etc/nginx/certs/hrm.emis.moe.gov.lk.key;

        location / {
            proxy_pass http://web:5173;

            # Re-declare headers (location-level overrides parent)
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support for Vite HMR
            proxy_http_version 1.1;
            proxy_set_header Upgrade    $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # ── apim.emis.moe.gov.lk → APIM console + gateway ────────────────
    server {
        listen 443 ssl;
        server_name apim.emis.moe.gov.lk;

        ssl_certificate     /etc/nginx/certs/apim.emis.moe.gov.lk.crt;
        ssl_certificate_key /etc/nginx/certs/apim.emis.moe.gov.lk.key;

        location / {
            proxy_pass https://apim.nemis:9443;
            proxy_ssl_verify off;
        }
    }

    # ── identity.emis.moe.gov.lk → IS console ─────────────────────────
    server {
        listen 443 ssl;
        server_name identity.emis.moe.gov.lk;

        ssl_certificate     /etc/nginx/certs/identity.emis.moe.gov.lk.crt;
        ssl_certificate_key /etc/nginx/certs/identity.emis.moe.gov.lk.key;

        location / {
            proxy_pass https://identity.nemis:9444;
            proxy_ssl_verify off;
        }
    }

    # ── service.emis.moe.gov.lk → APIM gateway ─────────────────────────
    server {
        listen 443 ssl;
        server_name service.emis.moe.gov.lk;

        ssl_certificate     /etc/nginx/certs/service.emis.moe.gov.lk.crt;
        ssl_certificate_key /etc/nginx/certs/service.emis.moe.gov.lk.key;

        location / {
            proxy_pass https://apim.nemis:8243;
            proxy_ssl_verify off;
        }
    }

    # ── HTTP → HTTPS redirect for all domains ──────────────────────────
    server {
        listen 80;
        server_name hrm.emis.moe.gov.lk apim.emis.moe.gov.lk identity.emis.moe.gov.lk service.emis.moe.gov.lk;
        return 301 https://$host$request_uri;
    }
}
