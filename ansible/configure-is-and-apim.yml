- name: Configure APIM and IS post-installation
  hosts: localhost
  gather_facts: false
  vars:
    # APIM connection settings
    apim_host: "{{ apim_hostname | default('apim.emis.moe.gov.lk') }}"
    apim_port: "{{ apim_mgmt_port | default('9443') }}"
    apim_admin_user: "{{ apim_admin_username | default('admin') }}"
    apim_admin_pass: "{{ apim_admin_password | default('admin') }}"

    # IS connection settings
    is_host: "{{ is_hostname | default('identity.emis.moe.gov.lk') }}"
    is_port: "{{ is_mgmt_port | default('9444') }}" # IS has offset=1
    is_admin_user: "{{ is_admin_username | default('admin') }}"
    is_admin_pass: "{{ is_admin_password | default('admin') }}"

    # Key Manager configuration
    key_manager_name: "nemis-idp"
    key_manager_display_name: "NEMIS IDP"
    key_manager_description: "NEMIS IDP as Key Manager"

    # Users to create (override with -e or in inventory)
    users_to_create: "{{ nemis_users | default([]) }}"

    # Roles to create (override with -e or in inventory)
    roles_to_create: "{{ nemis_roles | default([]) }}"

    # APIs to create (override with -e or in inventory)
    apis_to_create: "{{ nemis_apis | default([]) }}"

    # Applications to create (override with -e or in inventory)
    apps_to_create: "{{ nemis_apps | default([]) }}"

  tasks:
    # =========================================================================
    # PART 1: Register IS as Key Manager in APIM
    # =========================================================================

    - name: Wait for APIM to be ready
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/services/Version"
        method: GET
        validate_certs: no
        status_code: [200, 401, 403]
      register: apim_ready
      until: apim_ready.status in [200, 401, 403]
      retries: 30
      delay: 10

    - name: Wait for IS to be ready
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/configs"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        status_code: [200, 401, 403]
      register: is_ready
      until: is_ready.status in [200, 401, 403]
      retries: 30
      delay: 10

    - name: Check if Key Manager already exists
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/admin/v4/key-managers"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: existing_key_managers

    - name: Set fact for existing key manager
      set_fact:
        km_exists: "{{ existing_key_managers.json.list | selectattr('name', 'equalto', key_manager_name) | list | length > 0 }}"

    - name: Register WSO2 IS as Key Manager in APIM
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/admin/v4/key-managers"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ key_manager_name }}"
          displayName: "{{ key_manager_display_name }}"
          description: "{{ key_manager_description }}"
          type: "WSO2-IS-7"
          enabled: true
          tokenType: "DIRECT"
          wellKnownEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/token/.well-known/openid-configuration"
          introspectionEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/introspect"
          clientRegistrationEndpoint: "https://{{ is_host }}:{{ is_port }}/api/identity/oauth2/dcr/v1.1/register"
          tokenEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/token"
          displayTokenEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/token"
          revokeEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/revoke"
          displayRevokeEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/revoke"
          userInfoEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/userinfo"
          authorizeEndpoint: "https://{{ is_host }}:{{ is_port }}/oauth2/authorize"
          scopeManagementEndpoint: "https://{{ is_host }}:{{ is_port }}/api/identity/oauth2/v1.0/scopes"
          endpoints: []
          certificates:
            type: "JWKS"
            value: "https://{{ is_host }}:{{ is_port }}/oauth2/jwks"
          issuer: "https://{{ is_host }}:{{ is_port }}/oauth2/token"
          alias: ""
          availableGrantTypes:
            - refresh_token
            - urn:ietf:params:oauth:grant-type:saml2-bearer
            - password
            - client_credentials
            - iwa:ntlm
            - urn:ietf:params:oauth:grant-type:device_code
            - authorization_code
            - account_switch
            - urn:ietf:params:oauth:grant-type:token-exchange
            - organization_switch
            - urn:ietf:params:oauth:grant-type:jwt-bearer
          enableTokenGeneration: true
          enableTokenEncryption: false
          enableTokenHashing: false
          enableMapOAuthConsumerApps: true
          enableOAuthAppCreation: true
          enableSelfValidationJWT: true
          claimMapping: []
          consumerKeyClaim: "azp"
          scopesClaim: "scope"
          tokenValidation: []
          additionalProperties:
            Authentication: "BasicAuth"
            Username: "{{ is_admin_user }}"
            Password: "{{ is_admin_pass }}"
            api_resource_management_endpoint: "https://{{ is_host }}:{{ is_port }}/api/server/v1/api-resources"
            is7_roles_endpoint: "https://{{ is_host }}:{{ is_port }}/scim2/v2/Roles"
            enable_roles_creation: true
          permissions: null
          allowedOrganizations:
            - "ALL"
        status_code: [201, 200]
      register: km_registration
      when: not km_exists

    - name: Display Key Manager registration result
      debug:
        msg: "Key Manager '{{ key_manager_name }}' {{ 'already exists' if km_exists else 'registered successfully' }}"

    - name: Get Resident Key Manager details
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/admin/v4/key-managers"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: all_key_managers

    - name: Find Resident Key Manager
      set_fact:
        resident_km: "{{ all_key_managers.json.list | selectattr('name', 'equalto', 'Resident Key Manager') | first | default(None) }}"

    - name: Disable Resident Key Manager
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/admin/v4/key-managers/{{ resident_km.id }}"
        method: PUT
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ resident_km.name }}"
          type: "{{ resident_km.type }}"
          description: "{{ resident_km.description | default('Resident Key Manager') }}"
          enabled: false
          tokenType: "{{ resident_km.tokenType | default('DIRECT') }}"
        status_code: [200]
      when:
        - resident_km is not none
        - resident_km.enabled | default(false)
      register: resident_km_disabled

    - name: Display Resident Key Manager status
      debug:
        msg: "Resident Key Manager {{ 'disabled successfully' if (resident_km_disabled is defined and resident_km_disabled.status | default(0) == 200) else ('already disabled' if (resident_km is not none and not (resident_km.enabled | default(true))) else 'not found') }}"

    # =========================================================================
    # PART 2: Create Roles in IS
    # =========================================================================

    - name: Create roles in IS
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/scim2/v2/Roles"
        method: POST
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          displayName: "{{ role.name }}"
          permissions: "{{ role.permissions | default([]) }}"
        status_code: [201, 200, 409]
      loop: "{{ roles_to_create }}"
      loop_control:
        loop_var: role
        label: "{{ role.name }}"
      when: roles_to_create | length > 0

    # =========================================================================
    # PART 3: Create Users in IS
    # =========================================================================

    - name: Create users in IS via SCIM2
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/scim2/Users"
        method: POST
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          schemas:
            - "urn:ietf:params:scim:schemas:core:2.0:User"
            - "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"
          userName: "{{ user.username }}"
          password: "{{ user.password }}"
          name:
            givenName: "{{ user.first_name | default(user.username) }}"
            familyName: "{{ user.last_name | default('') }}"
          emails:
            - value: "{{ user.email | default(user.username + '@localhost') }}"
              primary: true
        status_code: [201, 200, 409]
      loop: "{{ users_to_create | default([]) }}"
      loop_control:
        loop_var: user
        label: "{{ user.username }}"
      when: users_to_create is defined and users_to_create | length > 0

    - name: Get created user IDs for role assignment
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/scim2/Users?filter=userName+eq+{{ user.username }}"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ users_to_create | default([]) }}"
      loop_control:
        loop_var: user
        label: "{{ user.username }}"
      register: user_lookups
      when: users_to_create is defined and users_to_create | length > 0 and (user.roles | default([]) | length > 0)

    - name: Assign roles to users
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/scim2/Users/{{ user_role.0.json.Resources[0].id }}"
        method: PATCH
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          schemas:
            - "urn:ietf:params:scim:api:messages:2.0:PatchOp"
          Operations:
            - op: "add"
              path: "groups"
              value:
                - display: "{{ user_role.1 }}"
        status_code: [200, 204]
      loop: "{{ user_lookups.results | default([]) | subelements('user.roles', skip_missing=True) }}"
      loop_control:
        loop_var: user_role
        label: "Assigning {{ user_role.1 }} to {{ user_role.0.user.username }}"
      when: user_lookups.results is defined and user_lookups.results | length > 0

    # =========================================================================
    # PART 4: Create and Publish APIs in APIM
    # =========================================================================

    - name: Check existing APIs
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis?query=name:{{ api.name | urlencode }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ apis_to_create | default([]) }}"
      loop_control:
        loop_var: api
        label: "{{ api.name }}"
      register: existing_apis
      when: apis_to_create is defined and apis_to_create | length > 0

    - name: Import API from OpenAPI URL
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/import-openapi"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "multipart/form-data"
        body_format: form-multipart
        body:
          url: "{{ api_check.api.openapi_url }}"
          additionalProperties: '{"name":"{{ api_check.api.name }}","version":"{{ api_check.api.version | default("1.0.0") }}","context":"{{ api_check.api.context }}","endpointConfig":{"endpoint_type":"http","sandbox_endpoints":{"url":"{{ api_check.api.endpoint_url }}"},"production_endpoints":{"url":"{{ api_check.api.endpoint_url }}"}}}'
        status_code: [201, 200]
      loop: "{{ existing_apis.results | default([]) }}"
      loop_control:
        loop_var: api_check
        label: "{{ api_check.api.name }}"
      register: created_apis
      when:
        - existing_apis.results is defined
        - api_check.json.count | default(0) == 0

    - name: Get API list for further operations
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis?query=name:{{ api.name | urlencode }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ apis_to_create | default([]) }}"
      loop_control:
        loop_var: api
        label: "{{ api.name }}"
      register: api_list
      when: apis_to_create is defined and apis_to_create | length > 0

    - name: Get full API details for CORS update
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ api_info.json.list[0].id }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ api_list.results | default([]) }}"
      loop_control:
        loop_var: api_info
        label: "{{ api_info.api.name }}"
      register: api_details
      when:
        - api_list.results is defined
        - api_info.json.count | default(0) > 0

    - name: Enable CORS and set subscription policies for APIs
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ api_full.json.id }}"
        method: PUT
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body: "{{ api_full.json | combine({'policies': api_full.api_info.api.subscription_policies | default(['Unlimited']), 'corsConfiguration': {'corsConfigurationEnabled': true, 'accessControlAllowOrigins': ['*'], 'accessControlAllowCredentials': false, 'accessControlAllowHeaders': ['authorization', 'Access-Control-Allow-Origin', 'Content-Type', 'SOAPAction', 'apikey', 'Internal-Key'], 'accessControlAllowMethods': ['GET', 'PUT', 'POST', 'DELETE', 'PATCH', 'OPTIONS']}}) }}"
        status_code: [200]
      loop: "{{ api_details.results | default([]) }}"
      loop_control:
        loop_var: api_full
        label: "{{ api_full.api_info.api.name }}"
      when:
        - api_details.results is defined
        - api_full.json is defined

    - name: Check existing API revisions
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ api_info.json.list[0].id }}/revisions"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ api_list.results | default([]) }}"
      loop_control:
        loop_var: api_info
        label: "{{ api_info.api.name }}"
      register: api_revisions
      when:
        - api_list.results is defined
        - api_info.json.count | default(0) > 0

    - name: Create API revision for deployment
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ rev_check.api_info.json.list[0].id }}/revisions"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          description: "Revision created by Ansible deployment"
        status_code: [201, 200]
      loop: "{{ api_revisions.results | default([]) }}"
      loop_control:
        loop_var: rev_check
        label: "{{ rev_check.api_info.api.name }}"
      register: created_revisions
      when:
        - api_revisions.results is defined
        - rev_check.json.count | default(0) == 0

    - name: Get latest API revision
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ api_info.json.list[0].id }}/revisions"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ api_list.results | default([]) }}"
      loop_control:
        loop_var: api_info
        label: "{{ api_info.api.name }}"
      register: latest_revisions
      when:
        - api_list.results is defined
        - api_info.json.count | default(0) > 0

    - name: Deploy API revision to gateway
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/{{ rev_info.api_info.json.list[0].id }}/deploy-revision?revisionId={{ rev_info.json.list[0].id }}"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          - name: "Default"
            vhost: "localhost"
            displayOnDevportal: true
        status_code: [200, 201]
      loop: "{{ latest_revisions.results | default([]) }}"
      loop_control:
        loop_var: rev_info
        label: "{{ rev_info.api_info.api.name }}"
      when:
        - latest_revisions.results is defined
        - rev_info.json.list | default([]) | length > 0
        - rev_info.json.list[0].deploymentInfo | default([]) | length == 0

    - name: Publish APIs to DevPortal
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/publisher/v4/apis/change-lifecycle?apiId={{ api_info.json.list[0].id }}&action=Publish"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        status_code: [200]
      loop: "{{ api_list.results | default([]) }}"
      loop_control:
        loop_var: api_info
        label: "{{ api_info.api.name }}"
      when:
        - api_list.results is defined
        - api_info.json.count | default(0) > 0
        - api_info.json.list[0].lifeCycleStatus != 'PUBLISHED'

    # =========================================================================
    # PART 5: Create Applications, Subscribe to APIs, and Generate Tokens
    # =========================================================================

    - name: Check existing applications
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications?query={{ app.name | urlencode }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ apps_to_create | default([]) }}"
      loop_control:
        loop_var: app
        label: "{{ app.name }}"
      register: existing_apps
      when: apps_to_create is defined and apps_to_create | length > 0

    - name: Create applications in DevPortal
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ app_check.app.name }}"
          description: "{{ app_check.app.description | default('') }}"
          throttlingPolicy: "{{ app_check.app.throttling_policy | default('Unlimited') }}"
          tokenType: "{{ app_check.app.token_type | default('JWT') }}"
        status_code: [201, 200]
      loop: "{{ existing_apps.results | default([]) }}"
      loop_control:
        loop_var: app_check
        label: "{{ app_check.app.name }}"
      when:
        - existing_apps.results is defined
        - app_check.json.count | default(0) == 0

    - name: Get application details
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications?query={{ app.name | urlencode }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ apps_to_create | default([]) }}"
      loop_control:
        loop_var: app
        label: "{{ app.name }}"
      register: app_details
      when: apps_to_create is defined and apps_to_create | length > 0

    - name: Get published APIs for subscription
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/apis?query=name:{{ api_name | urlencode }}"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ apps_to_create | default([]) | map(attribute='subscribe_to', default=[]) | flatten | unique }}"
      loop_control:
        loop_var: api_name
        label: "{{ api_name }}"
      register: published_apis
      when: apps_to_create is defined and apps_to_create | length > 0

    - name: Build API lookup dictionary
      set_fact:
        api_lookup: "{{ api_lookup | default({}) | combine({pub_api.api_name: {'id': pub_api.json.list[0].id, 'all_tiers': pub_api.json.list[0].throttlingPolicies | default([]), 'tiers': pub_api.json.list[0].throttlingPolicies | default([]) | reject('equalto', 'DefaultSubscriptionless') | list}}) }}"
      loop: "{{ published_apis.results | default([]) }}"
      loop_control:
        loop_var: pub_api
        label: "{{ pub_api.api_name }}"
      when:
        - published_apis.results is defined
        - pub_api.json.count | default(0) > 0

    - name: Subscribe applications to APIs
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/subscriptions"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          applicationId: "{{ app_sub.0.json.list[0].applicationId }}"
          apiId: "{{ api_lookup[app_sub.1].id }}"
          throttlingPolicy: "{{ api_lookup[app_sub.1].tiers[0] }}"
        status_code: [201, 200, 409]
      loop: "{{ app_details.results | default([]) | subelements('app.subscribe_to', skip_missing=True) }}"
      loop_control:
        loop_var: app_sub
        label: "{{ app_sub.0.app.name }} -> {{ app_sub.1 }}"
      when:
        - app_details.results is defined
        - app_sub.0.json.count | default(0) > 0
        - api_lookup is defined
        - app_sub.1 in api_lookup
        - api_lookup[app_sub.1].tiers | length > 0

    - name: Note subscriptionless APIs
      debug:
        msg: "API '{{ app_sub.1 }}' uses DefaultSubscriptionless only - no subscription needed"
      loop: "{{ app_details.results | default([]) | subelements('app.subscribe_to', skip_missing=True) }}"
      loop_control:
        loop_var: app_sub
        label: "{{ app_sub.1 }}"
      when:
        - api_lookup is defined
        - app_sub.1 in api_lookup
        - api_lookup[app_sub.1].tiers | length == 0

    - name: Check existing OAuth keys for applications
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications/{{ app_info.json.list[0].applicationId }}/oauth-keys"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ app_details.results | default([]) }}"
      loop_control:
        loop_var: app_info
        label: "{{ app_info.app.name }}"
      register: existing_keys
      when:
        - app_details.results is defined
        - app_info.json.count | default(0) > 0

    - name: Generate OAuth keys for applications (new)
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications/{{ keys_check.app_info.json.list[0].applicationId }}/generate-keys"
        method: POST
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          keyType: "PRODUCTION"
          keyManager: "{{ key_manager_name }}"
          grantTypesToBeSupported: "{{ keys_check.app_info.app.grant_types | default(['authorization_code']) }}"
          callbackUrl: "{{ keys_check.app_info.app.callback_url | default('') }}"
          additionalProperties:
            application_access_token_expiry_time: "{{ keys_check.app_info.app.token_expiry | default('3600') }}"
            user_access_token_expiry_time: "{{ keys_check.app_info.app.token_expiry | default('3600') }}"
            refresh_token_expiry_time: "{{ keys_check.app_info.app.refresh_token_expiry | default('86400') }}"
            id_token_expiry_time: "{{ keys_check.app_info.app.id_token_expiry | default('3600') }}"
          scopes: "{{ keys_check.app_info.app.scopes | default([]) }}"
          validityTime: "{{ keys_check.app_info.app.token_expiry | default(3600) }}"
        status_code: [200, 201]
      loop: "{{ existing_keys.results | default([]) }}"
      loop_control:
        loop_var: keys_check
        label: "{{ keys_check.app_info.app.name }}"
      when:
        - existing_keys.results is defined
        - keys_check.json.list | default([]) | length == 0

    - name: Update OAuth keys for applications (existing)
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications/{{ keys_check.app_info.json.list[0].applicationId }}/oauth-keys/{{ keys_check.json.list[0].keyMappingId }}"
        method: PUT
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          keyType: "PRODUCTION"
          keyManager: "{{ key_manager_name }}"
          supportedGrantTypes: "{{ keys_check.app_info.app.grant_types | default(['authorization_code']) }}"
          callbackUrl: "{{ keys_check.app_info.app.callback_url | default('') }}"
          additionalProperties:
            application_access_token_expiry_time: "{{ keys_check.app_info.app.token_expiry | default('3600') }}"
            user_access_token_expiry_time: "{{ keys_check.app_info.app.token_expiry | default('3600') }}"
            refresh_token_expiry_time: "{{ keys_check.app_info.app.refresh_token_expiry | default('86400') }}"
            id_token_expiry_time: "{{ keys_check.app_info.app.id_token_expiry | default('3600') }}"
        status_code: [200]
      loop: "{{ existing_keys.results | default([]) }}"
      loop_control:
        loop_var: keys_check
        label: "{{ keys_check.app_info.app.name }}"
      when:
        - existing_keys.results is defined
        - keys_check.json.list | default([]) | length > 0

    - name: Get application keys
      ansible.builtin.uri:
        url: "https://{{ apim_host }}:{{ apim_port }}/api/am/devportal/v3/applications/{{ app_info.json.list[0].applicationId }}/oauth-keys"
        method: GET
        validate_certs: no
        user: "{{ apim_admin_user }}"
        password: "{{ apim_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ app_details.results | default([]) }}"
      loop_control:
        loop_var: app_info
        label: "{{ app_info.app.name }}"
      register: app_keys
      when:
        - app_details.results is defined
        - app_info.json.count | default(0) > 0

    # =========================================================================
    # PART 6: Update Application Allowed Origins in IS
    # =========================================================================

    - name: Extract allowed origin from callback URL
      set_fact:
        app_allowed_origins: "{{ app_allowed_origins | default({}) | combine({keys_info.app_info.app.name: (keys_info.app_info.app.callback_url | regex_replace('(https?://[^/]+).*', '\\1'))}) }}"
      loop: "{{ app_keys.results | default([]) }}"
      loop_control:
        loop_var: keys_info
        label: "{{ keys_info.app_info.app.name }}"
      when:
        - app_keys.results is defined
        - keys_info.json.list | default([]) | length > 0
        - keys_info.app_info.app.callback_url is defined

    - name: Search for application in IS by consumer key
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications?filter=clientId+eq+{{ keys_info.json.list[0].consumerKey }}"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ app_keys.results | default([]) }}"
      loop_control:
        loop_var: keys_info
        label: "{{ keys_info.app_info.app.name }}"
      register: is_app_search
      when:
        - app_keys.results is defined
        - keys_info.json.list | default([]) | length > 0

    - name: Get full IS application details
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ is_search.json.applications[0].id }}"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ is_app_search.results | default([]) }}"
      loop_control:
        loop_var: is_search
        label: "{{ is_search.keys_info.app_info.app.name }}"
      register: is_app_details
      when:
        - is_app_search.results is defined
        - is_search.json.applications | default([]) | length > 0

    - name: Get current OIDC configuration from IS
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ is_details.json.id }}/inbound-protocols/oidc"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      loop: "{{ is_app_details.results | default([]) }}"
      loop_control:
        loop_var: is_details
        label: "{{ is_details.is_search.keys_info.app_info.app.name }}"
      register: is_oidc_config
      when:
        - is_app_details.results is defined
        - is_details.json is defined

    - name: Update IS application (callback URLs with regex + allowed origins + public client)
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ oidc_cfg.is_details.json.id }}/inbound-protocols/oidc"
        method: PUT
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body: "{{ oidc_cfg.json | combine({'callbackURLs': ['regexp=' + app_allowed_origins[oidc_cfg.is_details.is_search.keys_info.app_info.app.name] + '(/.*)?'], 'allowedOrigins': [app_allowed_origins[oidc_cfg.is_details.is_search.keys_info.app_info.app.name]], 'publicClient': oidc_cfg.is_details.is_search.keys_info.app_info.app.public_client | default(true)}) }}"
        status_code: [200]
      loop: "{{ is_oidc_config.results | default([]) }}"
      loop_control:
        loop_var: oidc_cfg
        label: "{{ oidc_cfg.is_details.is_search.keys_info.app_info.app.name }}"
      when:
        - is_oidc_config.results is defined
        - oidc_cfg.json is defined
        - app_allowed_origins is defined
        - oidc_cfg.is_details.is_search.keys_info.app_info.app.name in app_allowed_origins

    - name: Display IS application update status
      debug:
        msg: "Updated '{{ oidc_cfg.is_details.is_search.keys_info.app_info.app.name }}': callbackURLs=regexp={{ app_allowed_origins[oidc_cfg.is_details.is_search.keys_info.app_info.app.name] }}(/.*)?, publicClient=true"
      loop: "{{ is_oidc_config.results | default([]) }}"
      loop_control:
        loop_var: oidc_cfg
        label: "{{ oidc_cfg.is_details.is_search.keys_info.app_info.app.name }}"
      when:
        - is_oidc_config.results is defined
        - oidc_cfg.json is defined
        - app_allowed_origins is defined
        - oidc_cfg.is_details.is_search.keys_info.app_info.app.name in app_allowed_origins

    - name: Update IS application claim configuration (include roles and email in JWT)
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ is_details.json.id }}"
        method: PATCH
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          claimConfiguration:
            dialect: "LOCAL"
            requestedClaims:
              - claim:
                  uri: "http://wso2.org/claims/emailaddress"
                mandatory: false
              - claim:
                  uri: "http://wso2.org/claims/roles"
                mandatory: false
              - claim:
                  uri: "http://wso2.org/claims/groups"
                mandatory: false
            subject:
              claim:
                uri: "http://wso2.org/claims/userid"
              includeUserDomain: false
              includeTenantDomain: false
              useMappedLocalSubject: false
            role:
              includeUserDomain: false
              claim:
                uri: "http://wso2.org/claims/roles"
        status_code: [200]
      loop: "{{ is_app_details.results | default([]) }}"
      loop_control:
        loop_var: is_details
        label: "{{ is_details.is_search.keys_info.app_info.app.name }}"
      when:
        - is_app_details.results is defined
        - is_details.json is defined

    - name: Display claim configuration update status
      debug:
        msg: "Updated '{{ is_details.is_search.keys_info.app_info.app.name }}' claim configuration: email, roles, groups included in JWT"
      loop: "{{ is_app_details.results | default([]) }}"
      loop_control:
        loop_var: is_details
        label: "{{ is_details.is_search.keys_info.app_info.app.name }}"
      when:
        - is_app_details.results is defined
        - is_details.json is defined

    - name: Display generated credentials
      debug:
        msg: |
          Application: {{ keys_info.app_info.app.name }}
          Consumer Key: {{ keys_info.json.list[0].consumerKey | default('N/A') }}
          Consumer Secret: {{ keys_info.json.list[0].consumerSecret | default('N/A') }}
      loop: "{{ app_keys.results | default([]) }}"
      loop_control:
        loop_var: keys_info
        label: "{{ keys_info.app_info.app.name }}"
      when:
        - app_keys.results is defined
        - keys_info.json.list | default([]) | length > 0

    # =========================================================================
    # PART 7: Create M2M Application for SCIM2 API Access
    # =========================================================================

    - name: Check if M2M application already exists in IS
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications?filter=name+eq+CEMIS-LK+M2M"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: m2m_app_check

    - name: Set fact for M2M application existence
      set_fact:
        m2m_app_exists: "{{ m2m_app_check.json.totalResults | default(0) | int > 0 }}"

    - name: Set M2M app ID from existing app
      set_fact:
        m2m_app_id: "{{ m2m_app_check.json.applications[0].id }}"
      when: m2m_app_exists | bool

    - name: Create M2M application in IS
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications"
        method: POST
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          name: "CEMIS-LK M2M"
          description: "Machine-to-Machine application for SCIM2 API access"
          templateId: "m2m-application"
          inboundProtocolConfiguration:
            oidc:
              grantTypes:
                - "client_credentials"
              publicClient: false
              accessToken:
                type: "JWT"
                userAccessTokenExpiryInSeconds: 3600
                applicationAccessTokenExpiryInSeconds: 3600
        status_code: [201]
      register: m2m_app_created
      when: not (m2m_app_exists | bool)

    - name: Set M2M app ID from creation response
      set_fact:
        m2m_app_id: "{{ m2m_app_created.json.id }}"
      when:
        - not (m2m_app_exists | bool)
        - m2m_app_created is defined
        - m2m_app_created.json is defined

    - name: Get SCIM2 Users API resource ID
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/api-resources?filter=identifier+eq+/scim2/Users"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: scim2_users_api

    - name: Get SCIM2 Roles API resource ID
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/api-resources?filter=identifier+eq+/scim2/Roles"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: scim2_roles_api

    - name: Authorize M2M app for SCIM2 Users API
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ m2m_app_id }}/authorized-apis"
        method: POST
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          id: "{{ scim2_users_api.json.apiResources[0].id }}"
          policyIdentifier: "RBAC"
          scopes:
            - "internal_user_mgt_create"
            - "internal_user_mgt_update"
        status_code: [200, 201, 409]
      when:
        - m2m_app_id | length > 0
        - scim2_users_api.json.totalResults | default(0) | int > 0

    - name: Authorize M2M app for SCIM2 Roles API
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ m2m_app_id }}/authorized-apis"
        method: POST
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          id: "{{ scim2_roles_api.json.apiResources[0].id }}"
          policyIdentifier: "RBAC"
          scopes:
            - "internal_role_mgt_update"
        status_code: [200, 201, 409]
      when:
        - m2m_app_id | length > 0
        - scim2_roles_api.json.totalResults | default(0) | int > 0

    - name: Get M2M application OIDC configuration
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/api/server/v1/applications/{{ m2m_app_id }}/inbound-protocols/oidc"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: m2m_oidc_config
      when: m2m_app_id | length > 0

    - name: Get Teacher role ID from IS
      ansible.builtin.uri:
        url: "https://{{ is_host }}:{{ is_port }}/scim2/v2/Roles?filter=displayName+eq+Teacher"
        method: GET
        validate_certs: no
        user: "{{ is_admin_user }}"
        password: "{{ is_admin_pass }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
      register: teacher_role_lookup

    - name: Set Teacher role ID fact
      set_fact:
        teacher_role_id: "{{ teacher_role_lookup.json.Resources[0].id | default('NOT_FOUND') }}"
      when: teacher_role_lookup.json.totalResults | default(0) | int > 0

    - name: Display M2M application credentials
      debug:
        msg:
          - "============================================"
          - "M2M Application: CEMIS-LK M2M"
          - "============================================"
          - "Status: {{ 'Already existed' if m2m_app_exists else 'Created successfully' }}"
          - ""
          - "Add these to your .env file:"
          - "WSO2_ENABLED=true"
          - "WSO2_BASE_URL=https://{{ is_host }}:{{ is_port }}"
          - "WSO2_M2M_CLIENT_ID={{ m2m_oidc_config.json.clientId }}"
          - "WSO2_M2M_CLIENT_SECRET={{ m2m_oidc_config.json.clientSecret }}"
          - "WSO2_TEACHER_ROLE_ID={{ teacher_role_id | default('NOT_FOUND - create Teacher role first') }}"
          - "WSO2_VERIFY_SSL=false"
          - "============================================"
      when:
        - m2m_oidc_config is defined
        - m2m_oidc_config.json is defined

    - name: Configuration summary
      debug:
        msg:
          - "============================================"
          - "Configuration Complete!"
          - "============================================"
          - "Key Manager: {{ key_manager_name }} - {{ 'exists' if km_exists else 'created' }}"
          - "Roles created: {{ roles_to_create | length }}"
          - "Users created: {{ users_to_create | length }}"
          - "APIs created/published: {{ apis_to_create | default([]) | length }}"
          - "Applications created: {{ apps_to_create | default([]) | length }}"
          - "M2M Application: CEMIS-LK M2M - {{ 'exists' if m2m_app_exists else 'created' }}"
          - "============================================"
