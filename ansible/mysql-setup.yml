- name: Setup MySQL databases for WSO2
  hosts: mysql
  gather_facts: false
  collections:
    - community.mysql
  vars:
    mysql_host: "{{ hostvars[inventory_hostname].mysql_host | default('127.0.0.1', true) }}"
    mysql_port: "{{ hostvars[inventory_hostname].mysql_port | default(3307, true) }}"
    mysql_user: "{{ hostvars[inventory_hostname].mysql_user | default('nemis', true) }}"
    mysql_password: "{{ hostvars[inventory_hostname].mysql_password | default('nemis1234', true) }}"
    mysql_user_configured: "{{ hostvars[inventory_hostname].mysql_user_configured | default('wso2user', true) }}"
    mysql_user_configured_password: "{{ hostvars[inventory_hostname].mysql_user_configured_password | default('wso2pass', true) }}"
    # Database names from inventory
    mysql_apim_db: "{{ hostvars[inventory_hostname].mysql_apim_db | default('wso2_apim_db', true) }}"
    mysql_apim_shared_db: "{{ hostvars[inventory_hostname].mysql_apim_shared_db | default('wso2_apim_shared_db', true) }}"
    mysql_is_db: "{{ hostvars[inventory_hostname].mysql_is_db | default('wso2_is_db', true) }}"
    mysql_is_shared_db: "{{ hostvars[inventory_hostname].mysql_is_shared_db | default('wso2_is_shared_db', true) }}"
    # Paths
    resources_dir: "{{ playbook_dir }}/resources"
    work_dir: "/tmp/wso2-db-artifacts"
    wso2am_zip: "{{ resources_dir }}/wso2am-4.6.0.zip"
    wso2is_zip: "{{ resources_dir }}/wso2is-7.2.0.zip"
    wso2am_dir: "{{ work_dir }}/wso2am-4.6.0"
    wso2is_dir: "{{ work_dir }}/wso2is-7.2.0"
    # APIM scripts
    apim_db_script: "{{ wso2am_dir }}/dbscripts/apimgt/mysql.sql"
    apim_shared_db_script: "{{ wso2am_dir }}/dbscripts/mysql.sql"
    # IS scripts
    is_identity_db_script: "{{ wso2is_dir }}/dbscripts/identity/mysql.sql"
    is_consent_db_script: "{{ wso2is_dir }}/dbscripts/consent/mysql.sql"
    is_shared_db_script: "{{ wso2is_dir }}/dbscripts/mysql.sql"

    

  tasks:
    - name: Ensure PyMySQL client is installed for MySQL modules
      ansible.builtin.package:
        name: python3-pymysql
        state: present
      run_once: true

    - name: Ensure workspace exists
      ansible.builtin.file:
        path: "{{ work_dir }}"
        state: directory
        mode: "0755"
      run_once: true

    - name: Unarchive WSO2 APIM artifacts locally
      ansible.builtin.unarchive:
        src: "{{ wso2am_zip }}"
        dest: "{{ work_dir }}"
        remote_src: false
      run_once: true

    - name: Unarchive WSO2 IS artifacts locally
      ansible.builtin.unarchive:
        src: "{{ wso2is_zip }}"
        dest: "{{ work_dir }}"
        remote_src: false
      run_once: true

    # Drop all databases if they exist
    - name: Drop all WSO2 databases if they exist
      community.mysql.mysql_db:
        name: "{{ item }}"
        state: absent
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
      loop:
        - "{{ mysql_apim_db }}"
        - "{{ mysql_apim_shared_db }}"
        - "{{ mysql_is_db }}"
        - "{{ mysql_is_shared_db }}"

    # Create all 4 databases with explicit charset/collation
    - name: Create all WSO2 databases (latin1)
      community.mysql.mysql_query:
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
        query: >
          CREATE DATABASE IF NOT EXISTS `{{ item }}`
          CHARACTER SET latin1
          COLLATE latin1_swedish_ci;
      loop:
        - "{{ mysql_apim_db }}"
        - "{{ mysql_apim_shared_db }}"
        - "{{ mysql_is_db }}"
        - "{{ mysql_is_shared_db }}"

    # Ensure DB character set/collation are latin1 to avoid oversized indexes
    - name: Force latin1 character set on all WSO2 databases
      community.mysql.mysql_query:
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
        query: "ALTER DATABASE `{{ item }}` CHARACTER SET latin1 COLLATE latin1_swedish_ci;"
      loop:
        - "{{ mysql_apim_db }}"
        - "{{ mysql_apim_shared_db }}"
        - "{{ mysql_is_db }}"
        - "{{ mysql_is_shared_db }}"

    # Import scripts into APIM DB (product-specific: apimgt/mysql.sql)
    - name: Import APIM schema into APIM DB
      community.mysql.mysql_db:
        name: "{{ mysql_apim_db }}"
        state: import
        target: "{{ apim_db_script }}"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    # Import scripts into APIM shared DB (shared: dbscripts/mysql.sql from APIM)
    - name: Import shared schema into APIM shared DB
      community.mysql.mysql_db:
        name: "{{ mysql_apim_shared_db }}"
        state: import
        target: "{{ apim_shared_db_script }}"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    # Import scripts into IS DB (product-specific: identity/mysql.sql + consent/mysql.sql)
    - name: Import IS identity schema into IS DB
      community.mysql.mysql_db:
        name: "{{ mysql_is_db }}"
        state: import
        target: "{{ is_identity_db_script }}"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    - name: Import IS consent schema into IS DB
      community.mysql.mysql_db:
        name: "{{ mysql_is_db }}"
        state: import
        target: "{{ is_consent_db_script }}"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    # Import scripts into IS shared DB (shared: dbscripts/mysql.sql from IS)
    - name: Import shared schema into IS shared DB
      community.mysql.mysql_db:
        name: "{{ mysql_is_shared_db }}"
        state: import
        target: "{{ is_shared_db_script }}"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"

    # Grant configured application user full privileges on all databases
    - name: Grant configured MySQL user full privileges on all WSO2 databases
      community.mysql.mysql_user:
        name: "{{ mysql_user_configured }}"
        password: "{{ mysql_user_configured_password }}"
        host: "%"
        priv: "{{ item }}.*:ALL"
        append_privs: yes
        state: present
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
      loop:
        - "{{ mysql_apim_db }}"
        - "{{ mysql_apim_shared_db }}"
        - "{{ mysql_is_db }}"
        - "{{ mysql_is_shared_db }}"

    - name: Flush MySQL privileges
      community.mysql.mysql_query:
        query: "FLUSH PRIVILEGES"
        login_host: "{{ mysql_host }}"
        login_port: "{{ mysql_port }}"
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
